# Development Journal - February 2026

## 2026-02-01

### Session: Project Structure Reorganization

**Context**: Adopting labctl's `.claude/` organizational pattern for better Claude Code integration.

**Completed**:
- Created `.claude/` directory structure:
  - `skills/` - User-invocable skills (dbus, osc, tts)
  - `runbooks/` - Operational procedures
  - `docs/` - Technical documentation (separate from existing `docs/`)
  - `guidelines/` - Development standards (coding, protocols, discovery)
  - `journal/` - This development log
- Documented existing tools as skills
- Created protocol guidelines for D-Bus, OSC, and future protocols

**Previous state** (before this session):
- 11 working MCP tools across 3 plugins (dbus, osc, tts)
- Docs for KDE application D-Bus interfaces
- Screen recording and video combining capabilities

**Architecture**:
```
~/Dev/appmesh/
├── .claude/              # Claude Code integration
│   ├── skills/           # Invocable skills
│   ├── runbooks/         # Operational procedures
│   ├── docs/             # Architecture docs
│   ├── guidelines/       # Dev standards
│   └── journal/          # Work log
├── server/               # MCP server
│   ├── appmesh-mcp.php   # Entry point
│   ├── appmesh-core.php  # Shared core
│   └── plugins/          # Protocol plugins
├── docs/                 # App-specific D-Bus docs
└── web/                  # Web UI
```

**Future plugins discussed**:
- `cdp.php` - Chrome DevTools Protocol for Electron apps
- `midi.php` - PipeWire MIDI routing
- `websocket.php` - Bidirectional gateway

**Research completed**:
- OpenClaw: Not useful without messaging platform integration
- Protocols to explore: CDP, PipeWire MIDI, WebSocket, O2 (OSC successor)

**Next steps**:
- [x] Update CLAUDE.md to reference .claude/ structure
- [x] Create CDP plugin for Electron app automation
- [x] Add PipeWire MIDI plugin
- [x] Add WebSocket gateway for browser ↔ desktop bridging

---

## 2026-02-01 (continued)

### Session: New Protocol Plugins

**Context**: Adding CDP, MIDI, and WebSocket plugins to expand AppMesh beyond D-Bus/OSC.

**Completed**:
- Created `cdp.php` - Chrome DevTools Protocol plugin (6 tools)
  - Target discovery and version info
  - JavaScript execution in Electron apps
  - Screenshot capture via CDP
  - Navigation and DOM interaction
  - Requires `websocat` for WebSocket communication
- Created `midi.php` - PipeWire MIDI plugin (7 tools)
  - Port listing and connection management
  - ALSA hardware device discovery
  - MIDI event monitoring
  - Virtual MIDI port management via a2jmidid
  - MIDI to OSC bridging info
- Created `websocket.php` - WebSocket gateway plugin (5 tools)
  - Server lifecycle management
  - Broadcast messaging to all clients
  - Auto-generates server script on first start
  - Unix socket for control commands
- Created skill documentation for all new plugins
- Updated CLAUDE.md with new tool counts (33 tools across 6 plugins)

**Architecture decisions**:
- CDP uses `websocat` for WebSocket (simpler than PHP WebSocket extensions)
- MIDI uses native `pw-link` commands (no PHP MIDI library needed)
- WebSocket server auto-creates on first start
- All plugins follow same pattern: discovery tools + action tools

**Testing needed**:
- [ ] Test CDP with VS Code `--remote-debugging-port=9222`
- [ ] Test MIDI with actual hardware controller
- [ ] Test WebSocket with browser client
- [ ] Verify websocat installation on CachyOS

**Dependencies to install**:
```bash
paru -S websocat    # For CDP plugin
# a2jmidid already in repos for virtual MIDI
```

---

## 2026-02-01 (continued)

### Session: Config Plugin for Plasma 6.6

**Context**: Creating config.php plugin to manage KDE configuration and prepare for Plasma 6.6's theme snapshot feature.

**Completed**:
- Created `config.php` - KDE configuration management (11 tools)
  - Config file listing and reading (list, read, get, set)
  - Uses `kreadconfig6` and `kwriteconfig6` for safe editing
  - Global theme management (list, apply, current, export)
  - Uses `lookandfeeltool` for theme switching
  - Backup/restore of entire KDE configuration
  - Archives to `~/.local/share/appmesh/backups/`
  - Plasma 6.6 preparation with theme export skeleton
  - Info tool showing Plasma version and 6.6 features
- Created skill documentation for config plugin

**Plasma 6.6 research**:
- Release date: February 17, 2026
- Key feature: "Save As..." for global themes in System Settings
- Captures: colors, window decorations, icons, cursors, splash
- Locations: `~/.local/share/plasma/look-and-feel/`
- Tool: `lookandfeeltool --apply <theme-id>`
- SDK: `lookandfeelexplorer` for manual theme creation

**Tool counts updated**:
- Total: 48 tools across 7 plugins
- dbus: 8, osc: 3, tts: 6, cdp: 6, midi: 8, websocket: 6, config: 11

**CachyOS/Plasma standardization**:
- Config plugin enables backing up custom desktop appearance
- Theme export prepares for sharing standardized looks
- Plasma 6.6 will make this even easier with built-in snapshot

---

## 2026-02-01 (continued)

### Session: Kate D-Bus Research & Plugin Proposal

**Context**: Investigating text editor D-Bus capabilities and feasibility of a Kate plugin for full text control.

**Research completed**:
- Kate D-Bus interface documented in `docs/kate.md`
  - Can: openInput (inject text), openUrl, setCursor, activate, 90+ actions
  - Cannot: read text, modify text, select, find/replace
- Created `docs/text-editors.md` comparing Kate, KWrite, Konsole, Ghostwriter
- KWrite uses identical `org.kde.Kate.Application` interface (same framework)
- Konsole has richer API (`sendText`, `getAllDisplayedText`) but disabled by default
- Ghostwriter has no D-Bus at all

**Kate D-Bus Plugin proposal** (`docs/kate-dbus-plugin-proposal.md`):
- Feasibility: HIGH
- KTextEditor framework has full text manipulation API:
  - `text()`, `setText()`, `insertText()`, `removeText()`, `replaceText()`
  - Selection, cursor, undo/redo, find/replace
- Plugin would register D-Bus object at `/TextEditor`
- Interface: `org.kde.Kate.TextEditor`
- Works with Kate, KWrite, KDevelop, Kile - any KTextEditor app
- Effort: 2-4 days for experienced Qt/KDE developer

**Key insight**: The APIs exist inside KTextEditor - they're just not exposed via D-Bus. A plugin is the clean solution.

**Build requirements**:
- Qt 6 (Core, Widgets, DBus)
- KDE Frameworks 6 (KTextEditor, KCoreAddons, KI18n, KXmlGui)
- Extra CMake Modules (ECM)

**Added to CLAUDE.md**: Future Projects section with kate-dbus-text-plugin

---

## 2026-02-01 (continued)

### Session: KMail D-Bus Email Composition

**Context**: Creating a skill to compose emails directly via KMail D-Bus.

**Completed**:
- Discovered KMail `openComposer` D-Bus method has multiple overloads
- Simple 6-parameter version avoids attachment-related errors:
  `openComposer(to, cc, bcc, subject, body, hidden)`
- Extended version with identity parameter uses `uoid` from `~/.config/emailidentities`
- Fixed Akonadi "collection -1" error using `/usr/sbin/akonadictl fsck` and restart
- Created `/email` skill for composing emails with 72-char word wrap
- Updated `docs/kmail.md` with full parameter documentation

**Key findings**:
- Empty strings for QStringList params cause "Malformed URL" errors
- Use simple 6-param method to avoid attachment parameter issues
- Identity is set via `uoid` (unique object ID), not email address
- `akonadictl` is in `/usr/sbin/`, not in default PATH

**D-Bus method signatures**:
```
# Simple (recommended for Claude):
openComposer(QString to, cc, bcc, subject, body, bool hidden)

# With identity:
openComposer(to, cc, bcc, subject, body, hidden, messageFile,
             attachmentPaths, customHeaders, replyTo, inReplyTo,
             identity, htmlBody)
```

---

## 2026-02-01 (continued)

### Session: KMail/Akonadi Failure & Laravel PIM Research

**Context**: KMail repeatedly corrupted with "collection -1" errors. Even nuclear reset (deleting db_data, search_db, file_db_data) didn't fix it. Led to research on alternatives.

**Key findings**:
- Akonadi has been problematic since KDE 4 (2008)
- KDE PIM suite (KMail, KOrganizer, KAddressBook) all depend on Akonadi
- Thunderbird is the reliable alternative (has native CalDAV/CardDAV now)
- No mature Qt6 email client exists without Akonadi dependency
- Trojitá (Qt IMAP client) is unmaintained
- JMAP coming to Thunderbird iOS first, then desktop (2026+)

**Thunderbird solutions**:
- Email: Native IMAP (already working)
- Calendar: Native CalDAV (Settings → Calendar → New → Network)
- Contacts: Native CardDAV (Address Book → New → CardDAV)
- TbSync add-on no longer needed - built into Thunderbird 128+

**Laravel PIM proposal documented**:
- `.claude/docs/laravel-pim-proposal.md`
- Two project ideas:
  1. **Laravel DAV Server** - Replace Nextcloud for DAV-only customers
  2. **Laravel PIM Daemon** - Full Akonadi replacement with REST/D-Bus API
- Uses sabre/dav (PHP, not Python - respecting anti-Python stance)
- SQLite instead of MariaDB for simplicity

**Email skills created**:
- `/email` - KMail D-Bus compose (when KMail works)
- `/tb` - Thunderbird CLI compose (reliable)
- Both word-wrap at 72 chars for plain text

**Akonadi debugging commands** (for reference):
```bash
/usr/sbin/akonadictl fsck      # Check/repair database
/usr/sbin/akonadictl restart   # Restart service
mysql -u root -S ~/.local/share/akonadi/socket-*/mysql.socket akonadi
```

---

## Template for New Entries

```markdown
## YYYY-MM-DD

### Session: <Brief Title>

**Context**: Why this work is being done.

**Completed**:
- Item 1
- Item 2

**Decisions made**:
- Decision and rationale

**Blockers**:
- Any blockers encountered

**Next steps**:
- [ ] Task 1
- [ ] Task 2
```
